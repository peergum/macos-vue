"use strict";var g=Object.defineProperty;var y=(l,t,e)=>t in l?g(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var i=(l,t,e)=>(y(l,typeof t!="symbol"?t+"":t,e),e);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const w=require("ansi-to-html"),x=require("vue"),u=x.reactive({extensions:{}}),b=l=>{l!==void 0&&Object.assign(u.extensions,l)},B=new w;class C{constructor(t,e){i(this,"cwd",[]);i(this,"prompt","%");i(this,"commands",{});i(this,"buffer","");i(this,"typingBuffer","");i(this,"dir",{});i(this,"user","user");i(this,"host","host");i(this,"pos",0);i(this,"index");i(this,"history",[]);i(this,"historyIndex",0);i(this,"restore",()=>{const t=JSON.parse(localStorage.getItem("terminal."+this.index)??"{}");t!==void 0&&(this.buffer=t.buffer??this.getPrompt(),this.typingBuffer=t.typingBuffer??"",this.history=t.history??[],this.historyIndex=this.history.length)});i(this,"save",()=>{localStorage.setItem("terminal."+this.index,JSON.stringify({buffer:this.buffer,typingBuffer:this.typingBuffer,history:this.history}))});i(this,"setTerminal",t=>{this.dir=t.dir,this.user=t.user,this.host=t.host});i(this,"setUser",t=>{this.user=t});i(this,"goHistory",t=>{const e=this.historyIndex+t;e>=0&&e<this.history.length&&(this.typingBuffer=this.history[e],this.historyIndex=e)});i(this,"getCwd",()=>[...this.cwd]);i(this,"setCwd",t=>{this.cwd=t});i(this,"pushCwd",t=>{this.cwd.push(t)});i(this,"getPrompt",()=>this.user+"@"+this.host+" "+this.getcwd()+this.prompt+" ");i(this,"findDir",(t,e)=>{if(t.path!==void 0)return t;if(t.files===void 0)return;if(!e.length)return t.files;let s=[...e];const r=s.shift()??"";if(t.files[r]!==void 0)return this.findDir(t.files[r],s)});i(this,"newline",()=>{this.buffer+=this.typingBuffer+`
`,this.updatePos()});i(this,"updatePos",()=>{this.pos=this.buffer.length});i(this,"result",t=>{this.buffer+=t+this.getPrompt(),this.save(),this.updatePos()});i(this,"commandNotFound",t=>{this.result("Command "+t+` not found.
`)});i(this,"keypress",t=>{this.typingBuffer+=t});i(this,"backspace",()=>{this.typingBuffer.length>0&&(this.typingBuffer=this.typingBuffer.substring(0,this.typingBuffer.length-1))});i(this,"ctrlC",()=>{this.newline(),this.result(""),this.typingBuffer=""});i(this,"exec",async()=>{this.newline(),this.historyIndex=this.history.push(this.typingBuffer),console.log(this.history,this.historyIndex),this.typingBuffer==""&&this.result("");const t=String(this.typingBuffer).replace(/\\ /g,"ยบ").split(" ").map(s=>s.replace(/ยบ/g," "));this.typingBuffer="";const e=Object.entries(this.commands).find((s,r)=>s[0]===t[0]);if(!e)this.commandNotFound(t[0]);else{const s=await e[1][0](t.length>1?t.slice(1):[]);this.result(s)}});i(this,"help",t=>{if(t.length){const e=Object.entries(this.commands).find((s,r)=>s[0]===t[0]);return e?e[0]+" "+e[1][1]+" : "+e[1][2]+`
`:"Command "+t[0]+` not found.
`}return"Available commands: "+Object.keys(this.commands).sort((e,s)=>e[0]<s[0]?-1:e[0]===s[0]?0:1).join(", ")+"\nUse `help command` for more help\n"});i(this,"clear",()=>(this.buffer="",`
`));i(this,"historyCmd",t=>t.length&&t[0]==="-c"?(this.history=[],this.historyIndex=0,`
`):this.history.join(`
`)+`
`);i(this,"getmod",t=>{let e="";e+=t.path===void 0?"d":"-";const s=t.mod??(t.path===void 0?750:640),r=Math.floor(s/100),o=Math.floor(s%100/10),h=s%10;return e+=(r&4?"r":"-")+(r&2?"w":"-")+(r&1?"x":"-"),e+=(o&4?"r":"-")+(o&2?"w":"-")+(o&1?"x":"-"),e+=(h&4?"r":"-")+(h&2?"w":"-")+(h&1?"x":"-"),e});i(this,"ls",t=>{let e=!1;t[0]==="-l"&&(e=!0,t.shift());let s=[],r="",o=[],h={};const m=t.length>0;for(;;){o=this.getCwd(),console.log("ndir=",o),t.length&&t[0].split("/").forEach(n=>{n===".."&&o.length>0?o.pop():n!=="."&&o.push(n)}),h=this.findDir(this.dir,o);let d=[];if(h!==void 0)if(h.path!==void 0){let n="";e&&(n+="-r--r----- "),n+=t[0],s.push(n)}else console.log("cdir=",h),d=Object.entries(h).sort((n,c)=>n[0]<c[0]?-1:n[0]===c[0]?0:1).map((n,c)=>{let f="";const a=n[1].path!==void 0;if(e){console.log(n[0],n[1]),f+=this.getmod(n[1])+" ",f+=" "+(a?1:2)+" ";const p=n[1].owner?n[1].owner.split(":"):[this.user,"staff"];f+=p[0].padEnd(12)+" "+p[1].padEnd(8)+" "}return f+=a?n[0]:B.toHtml("\x1B[31m"+n[0]+"\x1B[0m"),f}),d.length&&(r+=(m?t[0]+`:
`:"")+d.join(e?`
`:" ")+`

`);if(t.length>1)t.shift();else break}return(s.length?s.join(e?`
`:" ")+`

`:"")+r});i(this,"pwd",()=>this.cwd.reduce((t,e)=>(t?t+"/":"")+e,"/home/"+this.user)+`
`);i(this,"getcwd",()=>{let t=this.getCwd();return t.length?t.pop()??"~":"~"});i(this,"cd",t=>{if(!t.length)return this.setCwd([]),`
`;let e=this.getCwd();t[0].split("/").forEach(r=>{r===".."&&e.length>0?e.pop():r!=="."&&e.push(r)});let s=this.findDir(this.dir,e);return s===void 0||s.path!==void 0?`Directory not found.
`:(this.setCwd(e),`
`)});i(this,"readContent",async t=>await fetch(t).then(async s=>await s.text().then(o=>o.replace(/\r?\n/g,"<br/>").replace(/ /g,"&nbsp;")).catch(o=>o)).catch(s=>s));i(this,"cat",async t=>{if(!t.length)return`Missing filename.
`;let e=this.getCwd();t[0].split("/").forEach(h=>{h===".."&&e.length>0?e.pop():h!=="."&&e.push(h)});const s=this.findDir(this.dir,e);if(s===void 0||s.path===void 0)return`File not found.
`;const r=s.path;return await this.readContent(r).then(h=>h).catch(h=>h)+`
`});this.index=e,this.setTerminal(t),this.cwd=[],this.prompt="%",this.commands={help:[this.help,"[command]","help with commands"],ls:[this.ls,"[-l][dir]","list files in directory"],pwd:[this.pwd,"","show current directory"],cd:[this.cd,"[dir]","change directory"],cat:[this.cat,"[filename]","dump a text file"],clear:[this.clear,"","clear terminal"],history:[this.historyCmd,"[-c]","show or clear history"],...u.extensions},this.buffer=this.getPrompt(),this.typingBuffer="",this.restore(),this.updatePos()}}exports.extendCommands=b;exports.terminal=C;exports.terminalStore=u;
